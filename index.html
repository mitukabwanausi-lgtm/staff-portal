<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Staff Job Viewer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .job-detail {
            font-family: 'Courier New', monospace;
        }
    </style>
</head>
<body class="bg-gray-50">
    <div id="app">
        <div class="bg-white shadow-sm sticky top-0 z-10">
            <div class="max-w-4xl mx-auto px-4 py-4">
                <div class="flex items-center justify-between">
                    <div>
                        <h1 class="text-2xl font-bold text-gray-900" id="staffNameHeader">Loading...</h1>
                        <p class="text-sm text-gray-500 mt-1" id="lastUpdate">Last updated: --:--:--</p>
                    </div>
                    <button onclick="loadJobs()" id="refreshBtn" class="flex items-center gap-2 px-4 py-2 bg-gray-100 hover:bg-gray-200 rounded-lg transition-colors">
                        <svg id="refreshIcon" class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                        </svg>
                        Refresh
                    </button>
                </div>
            </div>
        </div>
        <div class="max-w-4xl mx-auto px-4 mt-6" id="jobsContainer">
            <div class="bg-white rounded-lg shadow-sm p-12 text-center">
                <svg class="w-16 h-16 text-gray-300 mx-auto mb-4 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                </svg>
                <p class="text-gray-600">Loading jobs...</p>
            </div>
        </div>
    </div>

    <!-- Payment Modal -->
    <div id="paymentModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-lg shadow-xl max-w-md w-full p-6">
            <h2 class="text-xl font-bold text-gray-900 mb-4">Complete Job - Enter Payment</h2>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Amount Paid ($)</label>
                    <input type="number" id="amountPaid" step="0.01" placeholder="Enter amount" 
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                </div>
                
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Payment Method</label>
                    <div class="space-y-2">
                        <label class="flex items-center p-3 border border-gray-300 rounded-lg cursor-pointer hover:bg-gray-50">
                            <input type="radio" name="paymentMethod" value="Cash" checked class="w-4 h-4 text-green-600">
                            <span class="ml-3 text-gray-900">Cash</span>
                        </label>
                        <label class="flex items-center p-3 border border-gray-300 rounded-lg cursor-pointer hover:bg-gray-50">
                            <input type="radio" name="paymentMethod" value="Bank Transfer/Check" class="w-4 h-4 text-green-600">
                            <span class="ml-3 text-gray-900">Bank Transfer/Check</span>
                        </label>
                    </div>
                </div>
            </div>
            
            <div class="flex gap-3 mt-6">
                <button onclick="closePaymentModal()" 
                        class="flex-1 px-4 py-2 bg-gray-200 hover:bg-gray-300 text-gray-800 rounded-lg font-medium transition-colors">
                    Cancel
                </button>
                <button onclick="submitCompletion()" 
                        class="flex-1 px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg font-medium transition-colors">
                    Complete Job
                </button>
            </div>
        </div>
    </div>

    <script>
        const CONFIG = {
            SPREADSHEET_ID: '1ThGIfHzYItUgXWmFTgjdezFP7kvGCGfNI0MJzf95dzQ',
            API_KEY: 'AIzaSyClXOD97fX54o2RNIDsYeOgkOR1Xl3V7eU',
            SCRIPT_URL: 'https://script.google.com/macros/s/AKfycbyfUhrsbAHZQjWjMH-WPA0V9ErpU606PMkUtW2S5OKmZgoyRomQJCMABGwzdJBihiwp/exec',
            SHEET_NAME: 'Master Job List',
            AUTO_REFRESH_MINUTES: 2
        };
        const TOKEN_MAP = {
            'k8m3p9x2w5': 'Ben',
            'q7n4j1b8r6': 'Antonio',
            'v2h9f5l3d8': 'Anthony',
            'z5t6m2k9p4': 'Rudy',
            'w3r8n5j2t7': 'Benji'
        };
        let staffName = '';
        let jobs = [];
        let validToken = false;
        let pendingCompletionRow = null;
        let completedJobRows = new Set(); // Track locally completed jobs
        
        function getStaffName() {
            const params = new URLSearchParams(window.location.search);
            const token = params.get('token');
            if (token && TOKEN_MAP[token]) {
                staffName = TOKEN_MAP[token];
                validToken = true;
                document.getElementById('staffNameHeader').textContent = staffName + "'s Jobs";
            } else {
                validToken = false;
                document.getElementById('jobsContainer').innerHTML = `
                    <div class="bg-red-50 border border-red-200 rounded-lg p-12 text-center">
                        <svg class="w-16 h-16 text-red-300 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path>
                        </svg>
                        <h2 class="text-xl font-semibold text-red-800 mb-2">Access Denied</h2>
                        <p class="text-red-600">Invalid or missing access token. Please use the link provided by your manager.</p>
                    </div>
                `;
            }
        }
        
        async function loadJobs() {
            if (!validToken) return;
            const refreshIcon = document.getElementById('refreshIcon');
            refreshIcon.classList.add('animate-spin');
            
            try {
                const range = `${CONFIG.SHEET_NAME}!A2:O`;
                const url = `https://sheets.googleapis.com/v4/spreadsheets/${CONFIG.SPREADSHEET_ID}/values/${range}?key=${CONFIG.API_KEY}`;
                const response = await fetch(url);
                const data = await response.json();
                
                if (data.values) {
                    // Filter jobs for this staff member
                    // Show only jobs that are: assigned to them, not completed, AND released
                    jobs = data.values
                        .map((row, index) => ({
                            rowNumber: index + 2,
                            date: row[0] || '',           // A - Date ✅
                            startTime: row[1] || '',      // B - Start Time ✅
                            endTime: row[2] || '',        // C - End Time ✅
                            price: row[3] || '',          // D - Price ✅
                            name: row[4] || '',           // E - Client Name ✅
                            phone: row[5] || '',          // F - Phone ✅
                            email: row[6] || '',          // G - Email ✅
                            location: row[7] || '',       // H - Address ✅
                            description: row[8] || '',    // I - Job Description ✅
                            assignedTo: row[9] || '',     // J - Assigned To ✅ FIXED
                            status: row[10] || 'Assigned',// K - Status ✅ FIXED
                            photosLink: row[11] || '',    // L - Photos Link ✅
                            amountPaid: row[12] || '',    // M - Amount Paid ✅
                            paymentMethod: row[13] || '', // N - Payment Method ✅
                            released: row[14] || ''
                        }))
                        .filter(job => {
                            const assignedTo = job.assignedTo || '';
                            const status = job.status || 'Assigned';
                            const released = job.released || '';
                            
                            // Filter out jobs that are completed OR locally marked as completed
                            if (completedJobRows.has(job.rowNumber)) {
                                return false; // Hide jobs we just completed locally
                            }
                            
                            return assignedTo.toLowerCase() === staffName.toLowerCase() && 
                                   status.toLowerCase() !== 'completed' &&
                                   released.toLowerCase() === 'yes';
                        });
                    
                    renderJobs();
                } else {
                    jobs = [];
                    renderJobs();
                }
                
                const now = new Date();
                document.getElementById('lastUpdate').textContent = `Last updated: ${now.toLocaleTimeString()}`;
                
            } catch (error) {
                console.error('Error loading jobs:', error);
                document.getElementById('jobsContainer').innerHTML = `
                    <div class="bg-red-50 border border-red-200 rounded-lg p-6 text-center">
                        <p class="text-red-800 font-semibold">Error loading jobs</p>
                        <p class="text-red-600 text-sm mt-2">${error.message}</p>
                        <p class="text-red-600 text-sm mt-1">Please check your internet connection and try again.</p>
                    </div>
                `;
            } finally {
                refreshIcon.classList.remove('animate-spin');
            }
        }
        
        function renderJobs() {
            const container = document.getElementById('jobsContainer');
            
            if (jobs.length === 0) {
                container.innerHTML = `
                    <div class="bg-white rounded-lg shadow-sm p-12 text-center">
                        <svg class="w-16 h-16 text-gray-300 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        <h2 class="text-xl font-semibold text-gray-700 mb-2">No Active Jobs</h2>
                        <p class="text-gray-500">You're all caught up! Check back later for new assignments.</p>
                    </div>
                `;
                return;
            }
            
            const jobsHTML = jobs.map((job, index) => {
                const statusColor = getStatusColor(job.status);
                const showStartButton = job.status === 'Assigned' || job.status === '';
                const showCompleteButton = job.status === 'In Progress';
                
                return `
                    <div class="bg-white rounded-lg shadow-sm p-6 border border-gray-200 mb-4">
                        <div class="flex items-center justify-between mb-4">
                            <span class="px-3 py-1 rounded-full text-xs font-medium ${statusColor}">
                                ${job.status || 'Assigned'}
                            </span>
                            <span class="text-sm text-gray-500">Job #${index + 1}</span>
                        </div>
                        
                        <div class="space-y-2 job-detail text-sm">
                            <div><span class="font-semibold">Date:</span> ${job.date}</div>
                            <div><span class="font-semibold">Time:</span> ${job.time}</div>
                            <div><span class="font-semibold">Price:</span> ${job.price}</div>
                            <div><span class="font-semibold">Phone Number:</span> ${job.phone}</div>
                            <div><span class="font-semibold">Name:</span> ${job.name}</div>
                            <div><span class="font-semibold">Location:</span> ${job.location}</div>
                            <div class="pt-2">
                                <span class="font-semibold">Job Description:</span>
                                <p class="mt-1 text-gray-700 whitespace-pre-wrap">${job.description}</p>
                            </div>
                        </div>
                        
                        <div class="flex gap-3 mt-6 pt-4 border-t border-gray-200">
                            ${job.photosLink ? `
                                <a href="${job.photosLink}" target="_blank" rel="noopener noreferrer" 
                                   class="flex-1 px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg text-center font-medium transition-colors">
                                    View Photos
                                </a>
                            ` : `
                                <div class="flex-1 px-4 py-2 bg-gray-300 text-gray-500 rounded-lg text-center font-medium cursor-not-allowed">
                                    No Photos
                                </div>
                            `}
                            
                            ${showStartButton ? `
                                <button onclick="updateStatus(${job.rowNumber}, 'In Progress')" 
                                        class="flex-1 px-4 py-2 bg-yellow-500 hover:bg-yellow-600 text-white rounded-lg font-medium transition-colors">
                                    Start Job
                                </button>
                            ` : ''}
                            
                            ${showCompleteButton ? `
                                <button onclick="openPaymentModal(${job.rowNumber})" 
                                        class="flex-1 px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg font-medium transition-colors">
                                    Mark Complete
                                </button>
                            ` : ''}
                        </div>
                    </div>
                `;
            }).join('');
            
            container.innerHTML = `<div class="space-y-4">${jobsHTML}</div>`;
        }
        
        function openPaymentModal(rowNumber) {
            pendingCompletionRow = rowNumber;
            document.getElementById('amountPaid').value = '';
            document.querySelector('input[name="paymentMethod"][value="Cash"]').checked = true;
            document.getElementById('paymentModal').classList.remove('hidden');
        }
        
        function closePaymentModal() {
            document.getElementById('paymentModal').classList.add('hidden');
            pendingCompletionRow = null;
        }
        
        async function submitCompletion() {
            const amountPaid = document.getElementById('amountPaid').value;
            const paymentMethod = document.querySelector('input[name="paymentMethod"]:checked').value;
            
            if (!amountPaid || amountPaid <= 0) {
                alert('Please enter a valid amount paid.');
                return;
            }
            
            if (!pendingCompletionRow) {
                alert('Error: No job selected. Please refresh and try again.');
                closePaymentModal();
                return;
            }
            
            const rowToComplete = pendingCompletionRow;
            closePaymentModal();
            
            try {
                // Add to local completed cache
                completedJobRows.add(rowToComplete);
                
                // Remove completed job from UI immediately
                const jobIndex = jobs.findIndex(j => j.rowNumber === rowToComplete);
                if (jobIndex !== -1) {
                    jobs.splice(jobIndex, 1);
                    renderJobs();
                }
                
                console.log('Sending completion:', {
                    rowNumber: rowToComplete,
                    status: 'Completed',
                    amountPaid: amountPaid,
                    paymentMethod: paymentMethod,
                    staffName: staffName
                });
                
                const response = await fetch(CONFIG.SCRIPT_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        rowNumber: rowToComplete,
                        status: 'Completed',
                        amountPaid: amountPaid,
                        paymentMethod: paymentMethod,
                        staffName: staffName
                    })
                });
                
                console.log('Completion request sent');
                
                // Don't reload - job already removed from UI
                // Auto-refresh every 2 minutes will sync any new jobs
                
            } catch (error) {
                console.error('Error updating status:', error);
                alert('Failed to complete job. Please try again or contact your manager.');
                loadJobs();
            } finally {
                pendingCompletionRow = null;
            }
        }
        
        async function updateStatus(rowNumber, newStatus) {
            try {
                // Update UI immediately
                const jobIndex = jobs.findIndex(j => j.rowNumber === rowNumber);
                if (jobIndex !== -1) {
                    jobs[jobIndex].status = newStatus;
                    renderJobs();
                }
                
                await fetch(CONFIG.SCRIPT_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        rowNumber: rowNumber,
                        status: newStatus,
                        staffName: staffName
                    })
                });
                
                setTimeout(() => {
                    loadJobs();
                }, 1500);
                
            } catch (error) {
                console.error('Error updating status:', error);
                alert('Failed to update status. Please try again or contact your manager.');
                loadJobs();
            }
        }
        
        function getStatusColor(status) {
            switch (status) {
                case 'In Progress': return 'bg-blue-100 text-blue-800';
                case 'Completed': return 'bg-green-100 text-green-800';
                default: return 'bg-gray-100 text-gray-800';
            }
        }
        
        getStaffName();
        if (validToken) {
            loadJobs();
            setInterval(() => { loadJobs(); }, CONFIG.AUTO_REFRESH_MINUTES * 60 * 1000);
        }
    </script>
</body>
</html>
